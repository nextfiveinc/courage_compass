<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courage Compass</title>
    <style>
        /* --- Core Design & Theming --- */
        :root {
            --bg-primary: #ffffff; --bg-secondary: #f8f9fa; --bg-card: #ffffff;
            --text-primary: #212529; --text-secondary: #6c757d; --accent: #007bff;
            --accent-hover: #0056b3; --border: #dee2e6; --success: #28a745;
            --warning: #ffc107; --danger: #dc3545; --shadow: rgba(0,0,0,0.05);
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        [data-theme="dark"] {
            --bg-primary: #1a1a1a; --bg-secondary: #2d2d2d; --bg-card: #252525;
            --text-primary: #ffffff; --text-secondary: #b0b0b0; --accent: #4dabf7;
            --accent-hover: #339af0; --border: #404040; --success: #51cf66;
            --warning: #ffd43b; --danger: #ff6b6b; --shadow: rgba(0,0,0,0.2);
        }

        /* --- Base & Layout --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary);
            line-height: 1.6; transition: background-color 0.3s, color 0.3s; padding: 1rem;
        }
        main { max-width: 800px; margin: 0 auto; display: grid; gap: 1.5rem; }
        section, .card {
            background-color: var(--bg-card); border-radius: 12px; padding: 1.5rem;
            box-shadow: 0 2px 8px var(--shadow); border: 1px solid var(--border); transition: all 0.3s ease;
        }
        h1, h2, h3 { margin-bottom: 1rem; color: var(--accent); }
        h1 { font-size: 1.8rem; text-align: center; }
        h2 { font-size: 1.4rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
        h3 { font-size: 1.2rem; }

        /* --- Collapsible Sections (Details/Summary) --- */
        details {
             background-color: var(--bg-card); border-radius: 12px; padding: 1.5rem;
             box-shadow: 0 2px 8px var(--shadow); border: 1px solid var(--border); transition: all 0.3s ease;
        }
        details > summary {
            cursor: pointer; list-style: none; display: flex; align-items: center; gap: 0.5rem;
            padding: 0; margin: -1.5rem; padding: 1.5rem;
        }
        details[open] > summary {
            border-bottom: 1px solid var(--border);
        }
        details summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        details summary::before {
            content: '▶'; font-size: 0.8em; transition: transform 0.2s; transform-origin: center;
        }
        details[open] > summary::before { transform: rotate(90deg); }
        details .details-content { padding-top: 1.5rem; }

        /* --- Header & Controls --- */
        .app-header { text-align: center; padding-top: 1rem; border: none; box-shadow: none; background: none; }
        #challenge-controls-section {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        .settings-grid { display: flex; gap: 1.5rem; flex-wrap: wrap; justify-content: center; }
        .setting-group { display: flex; flex-direction: column; align-items: center; }
        label { font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: bold; color: var(--text-secondary); }
        select, textarea, input[type="text"] {
            padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background-color: var(--bg-secondary);
            color: var(--text-primary); font-size: 1rem; font-family: inherit; width: 100%; transition: all 0.3s ease;
        }
        select:focus, textarea:focus, input[type="text"]:focus {
            outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        .theme-toggle {
            cursor: pointer; font-size: 1.5rem; background: none; border: none; color: var(--text-primary);
            position: fixed; top: 1rem; right: 1rem;
        }

        /* --- Daily Challenge --- */
        #challenge-display {
            font-size: 1.2rem; font-style: italic; text-align: center; padding: 1.5rem; background-color: var(--bg-secondary);
            border-radius: 8px; border-left: 4px solid var(--accent); min-height: 50px;
        }

        /* --- Forms & Inputs --- */
        .form-group { margin-bottom: 1rem; }
        textarea { resize: vertical; min-height: 80px; }
        .outcome-selector { display: flex; justify-content: space-around; gap: 1rem; margin: 1.5rem 0; }
        .outcome-selector input[type="radio"] { display: none; }
        .outcome-selector label {
            flex-grow: 1; text-align: center; padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer;
            border: 2px solid var(--border); transition: all 0.2s ease-in-out; color: var(--text-primary);
        }
        #outcome-accepted:checked + label { border-color: var(--success); background-color: var(--success); color: #fff; }
        #outcome-rejected:checked + label { border-color: var(--danger); background-color: var(--danger); color: #fff; }
        #outcome-partial:checked + label { border-color: var(--warning); background-color: var(--warning); color: #000; }
        button, .btn {
            padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background-color: var(--accent);
            color: #fff; font-size: 1rem; font-weight: bold; cursor: pointer;
            transition: background-color 0.2s; text-decoration: none; display: inline-block;
        }
        button:hover, .btn:hover { background-color: var(--accent-hover); }
        button.secondary, .btn-secondary { background-color: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); }
        #reflection-questions {
            max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out;
        }
        #reflection-questions.visible {
            max-height: 1000px;
        }

        /* --- Progress & Stats --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; text-align: center; }
        .stat-item { background-color: var(--bg-secondary); padding: 1rem; border-radius: 8px; }
        .stat-value { font-size: 2rem; font-weight: bold; color: var(--accent); }
        .stat-label { font-size: 0.9rem; color: var(--text-secondary); }
        .badges { display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; }
        .badge { font-size: 2rem; opacity: 0.3; transition: opacity 0.5s, transform 0.5s; }
        .badge.earned { opacity: 1; transform: scale(1.1); animation: badgeEarn 0.5s ease-out; }
        @keyframes badgeEarn { 0% { transform: scale(0); } 50% { transform: scale(1.3); } 100% { transform: scale(1.1); } }

        /* --- Reflection Dashboard Chart --- */
        .chart-container { margin-bottom: 2rem; }
        .chart-title { text-align: center; font-size: 1.2rem; color: var(--text-secondary); }
        .bar-chart { display: flex; align-items: flex-end; height: 150px; gap: 1rem; margin: 2rem 0; padding: 1rem; border-bottom: 1px solid var(--border); }
        .bar { flex: 1; position: relative; min-width: 40px; transition: height 0.5s ease-out; }
        .bar.accepted { background-color: var(--success); }
        .bar.rejected { background-color: var(--danger); }
        .bar.partial { background-color: var(--warning); }
        .bar-label { position: absolute; bottom: -2rem; left: 0; right: 0; text-align: center; font-size: 0.8rem; color: var(--text-secondary); }
        .bar-value { position: absolute; top: -1.5rem; left: 0; right: 0; text-align: center; font-size: 0.9rem; font-weight: bold; color: var(--text-primary); }
        .word-cloud-container { margin-top: 3rem; }
        .word-cloud { display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; justify-content: center; align-items: center; padding: 1rem; min-height: 100px; }

        /* --- Custom Prompts --- */
        .custom-prompt-controls { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1.5rem; }
        .custom-prompt-controls input { flex-grow: 1; }
        .custom-prompt-item { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center; }
        .custom-prompt-item input { flex: 1; }
        .delete-prompt, .btn-danger { background: var(--danger); color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; }

        /* --- Data & Sharing --- */
        .data-controls { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; }
        #import-file-input { display: none; }
        .reset-container { margin-top: 2rem; text-align: right; }
        #reset-button { background: none; border: none; cursor: pointer; color: var(--text-secondary); opacity: 0.6; font-size: 1.5rem; transition: all 0.3s ease; }
        #reset-button:hover { opacity: 1; color: var(--danger); }
        #emailSummary { margin-top: 1rem; }
        #emailContent { min-height: 200px; background-color: var(--bg-secondary); }
        #sharing-section h3 { margin-bottom: 0.5rem; }

        /* --- Modals --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: var(--bg-card); margin: auto; padding: 2rem; border: 1px solid var(--border);
            border-radius: 12px; width: 90%; max-width: 700px; position: relative;
        }
        .modal-footer { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem; }
        .close-button {
            color: var(--text-secondary); position: absolute; top: 1rem; right: 1.5rem;
            font-size: 2rem; font-weight: bold; cursor: pointer;
        }
        #config-output, #bulk-prompts-input {
            width: 100%; height: 50vh; margin-top: 1rem; background-color: var(--bg-secondary);
            color: var(--text-primary); border: 1px solid var(--border); resize: vertical;
        }

        /* --- Utility --- */
        .hidden { display: none !important; }
        .copy-button { background: none; border: none; cursor: pointer; color: var(--text-primary); opacity: 0.6; float: right; }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }


    </style>
</head>
<body>

    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle light/dark mode">🌙</button>

    <main id="app">
        <header class="app-header">
            <h1>Courage Compass</h1>
            <p id="today-date"></p>
        </header>

        <section id="progress-overview-section">
            <div class="stats-grid">
                <div class="stat-item"><div class="stat-value" id="total-attempts">0</div><div class="stat-label">Attempts</div></div>
                <div class="stat-item"><div class="stat-value" id="total-rejections">0</div><div class="stat-label">Rejections</div></div>
                <div class="stat-item"><div class="stat-value" id="total-acceptances">0</div><div class="stat-label">Acceptances</div></div>
                <div class="stat-item"><div class="stat-value" id="current-streak">0</div><div class="stat-label">Day Streak</div></div>
            </div>
            <div class="badges"><span class="badge" id="badge-10" title="10 Rejections">🥉</span><span class="badge" id="badge-25" title="25 Rejections">🥈</span><span class="badge" id="badge-50" title="50 Rejections">🥇</span></div>
        </section>

        <section id="challenge-controls-section">
            <div class="settings-grid">
                <div class="setting-group">
                    <label for="difficulty">Difficulty</label>
                    <select id="difficulty"><option value="light">Light</option><option value="medium">Medium</option><option value="bold">Bold</option></select>
                </div>
                <div class="setting-group">
                    <label for="category">Category</label>
                    <select id="category"><option value="strangers">Strangers</option><option value="friends">Friends & Family</option><option value="services">Services & Business</option><option value="custom">Custom</option></select>
                </div>
            </div>
        </section>

        <section id="daily-challenge-section">
            <h2>Today's Challenge</h2>
            <div id="challenge-display">Select your settings and click "New Prompt" to start.</div>
            <button id="new-prompt-btn" style="width: 100%; margin-top: 1rem;">New Prompt</button>
        </section>

        <section id="custom-prompts-section" class="hidden">
            <h2>Custom Prompts</h2>
            <div class="custom-prompt-controls">
                <input type="text" id="new-custom-prompt" placeholder="Add a single prompt...">
                <button id="add-prompt-btn" class="btn">Add</button>
                <button id="bulk-edit-btn" class="btn-secondary">Bulk Edit</button>
            </div>
            <details id="custom-prompts-details">
                <summary><h3>Your Prompts</h3></summary>
                <div id="custom-prompts-list" style="margin-top: 1rem;"></div>
            </details>
        </section>

        <section id="log-entry-section">
            <h2>Log Your Attempt</h2>
            <form id="log-form">
                <div class="form-group"><label for="request-made">What did you ask for?</label><textarea id="request-made" required placeholder="e.g., Asked for a 10% discount on my coffee."></textarea></div>
                <div class="form-group"><label>What was the outcome?</label><div class="outcome-selector" id="outcome-selector"><input type="radio" id="outcome-accepted" name="outcome" value="accepted" required><label for="outcome-accepted">✅ Accepted</label><input type="radio" id="outcome-rejected" name="outcome" value="rejected"><label for="outcome-rejected">❌ Rejected</label><input type="radio" id="outcome-partial" name="outcome" value="partial"><label for="outcome-partial">🤝 Partial</label></div></div>
                
                <div id="reflection-questions">
                    <div class="form-group"><label for="reflection-1">How did you feel before?</label><textarea id="reflection-1" required placeholder="A bit nervous, but also excited..."></textarea></div>
                    <div class="form-group"><label for="reflection-2">How did you feel after?</label><textarea id="reflection-2" required placeholder="Relieved! It wasn't as bad as I thought..."></textarea></div>
                    <div class="form-group"><label for="reflection-3">What did you learn?</label><textarea id="reflection-3" required placeholder="I learned that people are generally nice..."></textarea></div>
                </div>

                <button type="submit" style="width:100%;">Save Log</button>
            </form>
        </section>

        <details>
            <summary><h2>Reflection Dashboard</h2></summary>
            <div class="details-content">
                <div class="chart-container"><h3 class="chart-title">Outcomes Breakdown</h3><div class="bar-chart" id="outcomes-chart"></div></div>
                <div class="word-cloud-container"><h3>Common "Asks" Word Cloud</h3><div class="word-cloud" id="word-cloud"><p>Log some attempts to see your word cloud!</p></div></div>
            </div>
        </details>
        
        <details>
            <summary><h2>Data & Sharing</h2></summary>
            <div class="details-content">
                <section id="data-controls-section" style="padding:0; border:0; box-shadow:none;">
                    <h3>Data Controls</h3>
                    <div class="data-controls"><button id="view-config-btn" class="btn-secondary">View Config</button><button id="export-btn" class="btn-secondary">Export Data</button><button id="import-btn" class="btn-secondary" onclick="document.getElementById('import-file-input').click();">Import Data</button><input type="file" id="import-file-input" accept=".json"></div>
                    <div class="reset-container"><button id="reset-button" title="Reset all data">🗑️</button></div>
                </section>
                <section id="sharing-section" style="padding:0; border:0; box-shadow:none; margin-top: 1.5rem;">
                     <h3>Email Summary</h3>
                     <div class="card hidden" id="emailSummary"><textarea id="emailContent" readonly></textarea><button class="copy-button" id="copy-summary-btn" title="Copy to clipboard">📋</button></div>
                     <button id="generate-summary-btn" class="btn" style="width: 100%; margin-top: 0.5rem;">Generate Summary</button>
                </section>
            </div>
        </details>
    </main>

    <!-- Modals -->
    <div id="config-modal" class="modal">
        <div class="modal-content"><span class="close-button" id="close-config-modal-btn">&times;</span><h2>Application Configuration <button class="copy-button" id="copy-config-btn" title="Copy to clipboard">📋</button></h2><textarea id="config-output" readonly></textarea></div>
    </div>
    <div id="bulk-prompts-modal" class="modal">
        <div class="modal-content"><span class="close-button" id="close-prompts-modal-btn">&times;</span><h2>Bulk Edit Custom Prompts</h2><p style="font-size: 0.9em; color: var(--text-secondary);">Enter one prompt per line. Blank lines will be ignored.</p><textarea id="bulk-prompts-input"></textarea><div class="modal-footer"><button id="cancel-prompts-btn" class="btn-secondary">Cancel</button><button id="save-prompts-btn" class="btn">Save Prompts</button></div></div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & CONSTANTS ---
        const state = { settings: { difficulty: 'light', category: 'strangers', theme: 'light' }, logs: [], customPrompts: [] };
        const PROMPTS = { /* Omitted for brevity */ strangers: { light: ["Ask a stranger for the time.", "Give a stranger a genuine compliment.", "Ask someone for directions, even if you know the way."], medium: ["Ask a barista to surprise you with their favorite drink.", "Ask a stranger to take a photo of you.", "Ask someone in a park what book they are reading."], bold: ["Ask a group of people if you can join their conversation for a minute.", "Ask a street performer if you can perform a (short) song or trick with them.", "Lie down on the sidewalk for 10 seconds."] }, friends: { light: ["Ask a friend to recommend a new song.", "Ask a family member to share a favorite childhood memory.", "Ask a friend for a small, easy favor."], medium: ["Ask a friend for honest feedback on a small project.", "Disagree with a friend on a minor topic (e.g., a movie review).", "Ask a friend to teach you a simple skill."], bold: ["Ask a friend for a loan of a small, specific amount of money ($5).", "Tell a friend you appreciate them and why, in detail.", "Ask a friend to hold you accountable for a goal."] }, services: { light: ["Ask for an extra napkin or packet of sauce.", "Ask a grocery store employee where to find an item.", "Ask if you can try a free sample."], medium: ["Ask for a discount on a slightly damaged item.", "Ask a waiter for their honest recommendation.", "Ask if there are any unadvertised specials."], bold: ["Ask for a free cup of coffee.", "When your meal comes, send it back and ask for something else (be polite!).", "Ask a business for a tour of their 'employees only' area."] } };

        // --- DOM ELEMENTS ---
        const DOMElements = {
            themeToggle: document.getElementById('theme-toggle'), dateDisplay: document.getElementById('today-date'),
            difficultySelect: document.getElementById('difficulty'), categorySelect: document.getElementById('category'),
            challengeDisplay: document.getElementById('challenge-display'), newPromptBtn: document.getElementById('new-prompt-btn'),
            logForm: document.getElementById('log-form'), requestMadeInput: document.getElementById('request-made'),
            outcomeSelector: document.getElementById('outcome-selector'),
            reflectionQuestions: document.getElementById('reflection-questions'),
            reflection1Input: document.getElementById('reflection-1'), reflection2Input: document.getElementById('reflection-2'), reflection3Input: document.getElementById('reflection-3'),
            totalAttempts: document.getElementById('total-attempts'), totalRejections: document.getElementById('total-rejections'), totalAcceptances: document.getElementById('total-acceptances'),
            currentStreak: document.getElementById('current-streak'), badge10: document.getElementById('badge-10'), badge25: document.getElementById('badge-25'), badge50: document.getElementById('badge-50'),
            outcomesChart: document.getElementById('outcomes-chart'), wordCloud: document.getElementById('word-cloud'),
            customPromptsSection: document.getElementById('custom-prompts-section'), newCustomPromptInput: document.getElementById('new-custom-prompt'),
            addPromptBtn: document.getElementById('add-prompt-btn'), bulkEditBtn: document.getElementById('bulk-edit-btn'),
            customPromptsDetails: document.getElementById('custom-prompts-details'), customPromptsList: document.getElementById('custom-prompts-list'),
            exportBtn: document.getElementById('export-btn'), importInput: document.getElementById('import-file-input'), resetBtn: document.getElementById('reset-button'),
            generateSummaryBtn: document.getElementById('generate-summary-btn'), emailSummaryCard: document.getElementById('emailSummary'),
            emailContent: document.getElementById('emailContent'), copySummaryBtn: document.getElementById('copy-summary-btn'),
            configModal: document.getElementById('config-modal'), closeConfigModalBtn: document.getElementById('close-config-modal-btn'),
            viewConfigBtn: document.getElementById('view-config-btn'), configOutput: document.getElementById('config-output'), copyConfigBtn: document.getElementById('copy-config-btn'),
            bulkPromptsModal: document.getElementById('bulk-prompts-modal'), closePromptsModalBtn: document.getElementById('close-prompts-modal-btn'),
            bulkPromptsInput: document.getElementById('bulk-prompts-input'), savePromptsBtn: document.getElementById('save-prompts-btn'), cancelPromptsBtn: document.getElementById('cancel-prompts-btn'),
        };
        
        // --- DATA HELPERS ---
        const saveData = () => localStorage.setItem('rejectionTherapyData', JSON.stringify(state));
        const loadData = () => { const data = localStorage.getItem('rejectionTherapyData'); if (data) Object.assign(state, JSON.parse(data)); };

        // --- RENDER & UPDATE ---
        const render = () => {
            DOMElements.difficultySelect.value = state.settings.difficulty; DOMElements.categorySelect.value = state.settings.category;
            document.documentElement.setAttribute('data-theme', state.settings.theme);
            DOMElements.themeToggle.textContent = state.settings.theme === 'dark' ? '☀️' : '🌙';
            updateStats(); updateDashboard(); updateCustomPromptsList(); updateCustomPromptsVisibility();
        };

        const updateStats = () => { /* Logic unchanged */ const acceptedCount = state.logs.filter(log => log.outcome === 'accepted').length; const rejectedCount = state.logs.filter(log => log.outcome === 'rejected').length; DOMElements.totalAttempts.textContent = state.logs.length; DOMElements.totalRejections.textContent = rejectedCount; DOMElements.totalAcceptances.textContent = acceptedCount; DOMElements.badge10.classList.toggle('earned', rejectedCount >= 10); DOMElements.badge25.classList.toggle('earned', rejectedCount >= 25); DOMElements.badge50.classList.toggle('earned', rejectedCount >= 50); DOMElements.currentStreak.textContent = calculateStreak(); };
        const updateDashboard = () => { updateOutcomesChart(); generateWordCloud(); };
        const updateOutcomesChart = () => { /* Logic unchanged */ const chart = DOMElements.outcomesChart; chart.innerHTML = ''; if (state.logs.length === 0) { chart.innerHTML = '<div style="text-align: center; width: 100%; color: var(--text-secondary);">No data yet</div>'; return; } const outcomes = { accepted: state.logs.filter(log => log.outcome === 'accepted').length, rejected: state.logs.filter(log => log.outcome === 'rejected').length, partial: state.logs.filter(log => log.outcome === 'partial').length }; const maxCount = Math.max(...Object.values(outcomes)); Object.entries(outcomes).forEach(([outcome, count]) => { if (count === 0) return; const barHeight = maxCount > 0 ? (count / maxCount) * 130 : 0; const barEl = document.createElement('div'); barEl.className = `bar ${outcome}`; barEl.style.height = `${barHeight}px`; barEl.innerHTML = `<div class="bar-value">${count}</div><div class="bar-label">${outcome.charAt(0).toUpperCase() + outcome.slice(1)}</div>`; chart.appendChild(barEl); }); };
        const generateWordCloud = () => { /* Logic unchanged */ const text = state.logs.map(log => log.request).join(' '); const words = text.toLowerCase().match(/\b(\w+)\b/g) || []; const stopWords = new Set(['i','a','an','the','and','or','for','to','of','in','on','at','my','me','you','is','was','were','it','if','that','get','ask','asked']); const freq = words.reduce((acc, word) => { if (!stopWords.has(word) && word.length > 2) { acc[word] = (acc[word] || 0) + 1; } return acc; }, {}); const sortedWords = Object.entries(freq).sort((a, b) => b[1] - a[1]).slice(0, 20); if (sortedWords.length === 0) { DOMElements.wordCloud.innerHTML = '<p>Log some attempts to see your word cloud!</p>'; return; } const maxFreq = sortedWords[0][1]; const minFreq = sortedWords[sortedWords.length - 1][1]; DOMElements.wordCloud.innerHTML = sortedWords.map(([word, count]) => { const size = 1 + ((count - minFreq) / (maxFreq - minFreq + 1)) * 1.5; const opacity = 0.6 + ((count - minFreq) / (maxFreq - minFreq + 1)) * 0.4; return `<span style="font-size: ${size}rem; opacity: ${opacity};">${word}</span>`; }).join(''); };
        const calculateStreak = () => { /* Logic unchanged */ if (state.logs.length === 0) return 0; const uniqueDays = [...new Set(state.logs.map(log => new Date(log.date).toDateString()))].map(dateStr => new Date(dateStr)).sort((a, b) => b - a); if (uniqueDays.length === 0) return 0; let streak = 0; const today = new Date(); const yesterday = new Date(); yesterday.setDate(today.getDate() - 1); const isTodayLogged = uniqueDays[0].toDateString() === today.toDateString(); const isYesterdayLogged = uniqueDays[0].toDateString() === yesterday.toDateString(); if (isTodayLogged || isYesterdayLogged) { streak = 1; for (let i = 0; i < uniqueDays.length - 1; i++) { const diff = (uniqueDays[i] - uniqueDays[i+1]) / (1000 * 60 * 60 * 24); if (diff === 1) { streak++; } else { break; } } } return streak; };
        
        // --- CUSTOM PROMPTS LOGIC ---
        const updateCustomPromptsVisibility = () => DOMElements.customPromptsSection.classList.toggle('hidden', state.settings.category !== 'custom');
        const updateCustomPromptsList = () => {
            const list = DOMElements.customPromptsList; list.innerHTML = '';
            if (state.customPrompts.length === 0) { list.innerHTML = '<p style="color: var(--text-secondary)">You have no custom prompts yet.</p>'; return; }
            state.customPrompts.forEach((prompt, index) => {
                const item = document.createElement('div'); item.className = 'custom-prompt-item';
                item.innerHTML = `<input type="text" value="${prompt}" data-index="${index}" class="custom-prompt-input"><button class="delete-prompt" data-index="${index}">×</button>`;
                list.appendChild(item);
            });
        };
        const addCustomPrompt = () => {
            const newPrompt = DOMElements.newCustomPromptInput.value.trim();
            if (newPrompt) {
                state.customPrompts.push(newPrompt); saveData(); updateCustomPromptsList();
                DOMElements.newCustomPromptInput.value = '';
                DOMElements.customPromptsDetails.open = true;
            }
        };
        const generateNewPrompt = () => { /* Logic unchanged */ const { difficulty, category } = state.settings; let promptList; if (category === 'custom') { promptList = state.customPrompts; if (!promptList || promptList.length === 0) { DOMElements.challengeDisplay.textContent = "Add some custom prompts below to get started!"; return; } } else { promptList = PROMPTS[category][difficulty]; } const randomIndex = Math.floor(Math.random() * promptList.length); DOMElements.challengeDisplay.textContent = promptList[randomIndex] || "No prompts available."; };

        // --- SHARING & DATA ---
        const generateEmailSummary = () => { /* Logic unchanged */ const { logs } = state; if (logs.length === 0) { return "No attempts logged yet."; } const stats = { attempts: logs.length, accepted: logs.filter(l => l.outcome === 'accepted').length, rejected: logs.filter(l => l.outcome === 'rejected').length, streak: calculateStreak() }; const recentLogs = logs.slice(-3).reverse(); let summary = `# My Courage Compass Journey\n\n## Progress Summary\n- **Total Attempts**: ${stats.attempts}\n- **Rejections**: ${stats.rejected}\n- **Current Streak**: ${stats.streak} days\n\n`; if (recentLogs.length > 0) { summary += `## Recent Attempts\n`; recentLogs.forEach(log => { const outcome = log.outcome === 'accepted' ? '✅' : log.outcome === 'rejected' ? '❌' : '🤝'; summary += `- ${outcome} ${log.request}\n`; }); } return summary.trim(); };
        const copyToClipboard = (text, buttonElement) => navigator.clipboard.writeText(text).then(() => { const originalText = buttonElement.textContent; buttonElement.textContent = 'Copied!'; setTimeout(() => { buttonElement.textContent = originalText; }, 2000); }).catch(err => { console.error('Failed to copy: ', err); alert('Failed to copy.'); });
        
        // --- EVENT HANDLERS ---
        DOMElements.themeToggle.onclick = () => { state.settings.theme = state.settings.theme === 'light' ? 'dark' : 'light'; saveData(); render(); };
        DOMElements.difficultySelect.onchange = e => { state.settings.difficulty = e.target.value; saveData(); };
        DOMElements.categorySelect.onchange = e => { state.settings.category = e.target.value; saveData(); updateCustomPromptsVisibility(); };
        DOMElements.newPromptBtn.onclick = generateNewPrompt;
        DOMElements.addPromptBtn.onclick = addCustomPrompt;
        DOMElements.newCustomPromptInput.onkeypress = e => { if (e.key === 'Enter') { e.preventDefault(); addCustomPrompt(); }};
        DOMElements.customPromptsList.onclick = e => { if (e.target.classList.contains('delete-prompt')) { const index = parseInt(e.target.dataset.index, 10); state.customPrompts.splice(index, 1); saveData(); updateCustomPromptsList(); } };
        DOMElements.customPromptsList.onchange = e => { if (e.target.classList.contains('custom-prompt-input')) { const index = parseInt(e.target.dataset.index, 10); state.customPrompts[index] = e.target.value.trim(); saveData(); } };
        DOMElements.outcomeSelector.addEventListener('change', () => DOMElements.reflectionQuestions.classList.add('visible'));
        
        DOMElements.logForm.onsubmit = e => {
            e.preventDefault(); 
            const outcome = document.querySelector('input[name="outcome"]:checked');
            if (!outcome) { alert('Please select an outcome (Accepted, Rejected, or Partial) before saving.'); return; }
            const newLog = { date: new Date().toISOString(), request: DOMElements.requestMadeInput.value, outcome: outcome.value, reflection1: DOMElements.reflection1Input.value, reflection2: DOMElements.reflection2Input.value, reflection3: DOMElements.reflection3Input.value };
            state.logs.push(newLog); saveData(); render();
            DOMElements.logForm.reset(); DOMElements.reflectionQuestions.classList.remove('visible');
            alert('Log saved successfully!');
        };
        
        DOMElements.exportBtn.onclick = () => { /* Logic unchanged */ const dataStr = JSON.stringify(state, null, 2); const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr); const linkElement = document.createElement('a'); linkElement.setAttribute('href', dataUri); linkElement.setAttribute('download', `courage-compass-backup-${new Date().toISOString().split('T')[0]}.json`); linkElement.click(); };
        DOMElements.importInput.onchange = e => { /* Logic unchanged */ const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const importedData = JSON.parse(event.target.result); if (importedData.settings && importedData.logs) { if (confirm('This will overwrite all current data. Are you sure?')) { Object.assign(state, importedData); saveData(); render(); } } else { alert('Invalid data file.'); } } catch (error) { alert('Error reading file.'); } }; reader.readAsText(file); e.target.value = ''; };
        let resetClicks = 0; DOMElements.resetBtn.onclick = () => { /* Logic unchanged */ resetClicks++; if (resetClicks === 1) { DOMElements.resetBtn.textContent = '❓'; setTimeout(() => { DOMElements.resetBtn.innerHTML = '🗑️'; resetClicks = 0; }, 3000); } else if (resetClicks === 2) { if (confirm('FINAL WARNING: This will permanently delete all your data. Continue?')) { localStorage.removeItem('rejectionTherapyData'); location.reload(); } else { DOMElements.resetBtn.innerHTML = '🗑️'; resetClicks = 0; } } };
        DOMElements.generateSummaryBtn.onclick = () => { const summary = generateEmailSummary(); DOMElements.emailContent.value = summary; DOMElements.emailSummaryCard.classList.remove('hidden'); DOMElements.emailSummaryCard.scrollIntoView({ behavior: 'smooth' }); };
        DOMElements.copySummaryBtn.onclick = () => copyToClipboard(DOMElements.emailContent.value, DOMElements.copySummaryBtn);
        
        // --- MODAL HANDLERS ---
        const openModal = (modal) => modal.style.display = 'flex';
        const closeModal = (modal) => modal.style.display = 'none';
        
        DOMElements.viewConfigBtn.onclick = () => { DOMElements.configOutput.value = JSON.stringify(state, null, 2); openModal(DOMElements.configModal); };
        DOMElements.closeConfigModalBtn.onclick = () => closeModal(DOMElements.configModal);
        DOMElements.copyConfigBtn.onclick = () => copyToClipboard(DOMElements.configOutput.value, DOMElements.copyConfigBtn);
        
        DOMElements.bulkEditBtn.onclick = () => { DOMElements.bulkPromptsInput.value = state.customPrompts.join('\n'); openModal(DOMElements.bulkPromptsModal); };
        DOMElements.closePromptsModalBtn.onclick = () => closeModal(DOMElements.bulkPromptsModal);
        DOMElements.cancelPromptsBtn.onclick = () => closeModal(DOMElements.bulkPromptsModal);
        DOMElements.savePromptsBtn.onclick = () => {
            const newPrompts = DOMElements.bulkPromptsInput.value.split('\n').map(p => p.trim()).filter(p => p);
            state.customPrompts = newPrompts;
            saveData(); updateCustomPromptsList(); closeModal(DOMElements.bulkPromptsModal);
        };
        window.onclick = (e) => { if (e.target == DOMElements.configModal) closeModal(DOMElements.configModal); if (e.target == DOMElements.bulkPromptsModal) closeModal(DOMElements.bulkPromptsModal); };

        // --- INITIALIZATION ---
        const init = () => {
            loadData();
            DOMElements.dateDisplay.textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            render();
        };
        init();
    });
    </script>
</body>
</html>
